<!DOCTYPE html>
  <html>

  <head>
    <meta charset=utf-8 />
    <title>Rocky_Mountain_High</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <link rel='icon' href='https://newmapsplus.github.io/favicon.ico' type='image/x-icon' />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.0/normalize.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.3.4/leaflet.css">
    <link href="https://fonts.googleapis.com/css?family=Lato:300,300i,400,900i" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Lora|Roboto:400,700" rel="stylesheet">

    <style>
      body {
        margin: 0;
        padding: 0;
        background: #e3e3e6;
        Font-Family: 'Lora', Serif;
        font-weight: 300;
        color: #3d3d3d;
        font-size: 100%;
      }

      header,
      section,
      footer {
        width: 80%;
        margin: 10px auto;
      }

      h1 {
        font-weight: 800;
        font-size: 2.3em;
        font-style: italic;
        Font-Family: 'Roboto', Sans-Serif;
        letter-spacing: .02em;
        margin: 5px 0;
      }

      h2 {
        font-weight: 300;
        Color: gray;
        font-size: 1.4em;
        letter-spacing: .04em;

        Font-Family: 'Roboto', Sans-Serif;
        margin: 5px 0;
      }

      h3 {
        font-weight: 300;
        font-size: 1.4em;
        margin-bottom: 5px;
        Font-Family: 'Lora', Serif;
        Color: gray;
      }

      h4 {
        font-size: 1.4em;
        font-style: italic;
        Font-Family: 'Lora', Serif;
        letter-spacing: .02em;
        margin: 25px 0 0 0;
        Color: #3d3d3d;
      }

      p {
        font-size: 1.1em;
        line-height: 1.4em;
        margin-bottom: 5px;
      }

      ul {
        padding: 0px 20px 4px 20px;
        font-size: 1.1em;
        line-height: 1.2em;
        color: #63666a;
      }

      li {
        margin: 10px 0
      }

      hr {
        margin: 20px 0;
        border: 0;
        height: 1px;
        background: #63666a;
      }

      .linkbox {
        margin: 3px 0 20px 0;
        display: block;
        font-size: 0.9em;
        font-weight: 300;
        line-height: 1.3em;
      }



      h5 {
        display: inline-block;
        color: #001323;
      }

      #map {
        width: 100%;
        height: 580px;
        margin: 20px auto;
      }

      .max-image-width {
        width: 100%;
      }

      /* Use float property to make two-column layout */
      .first-column {
        float: left;
        width: 49%;
        padding-right: 2%;
      }

      .column {
        float: left;
        width: 49%;
      }

      /* Clear floats after the columns */
      .row::after {
        content: "";
        display: block;
        clear: both;
      }

      /* When browser is 900px wide or less */
      @media screen and (max-width: 900px) {

        .first-column,
        .column {
          width: 100%;
        }

        h1 {
          font-size: 1.8em;
        }
      }

      /* map legend styles*/
      .legend {
        padding: 6px 8px;
        font-size: 1em;
        background: rgba(255, 255, 255, 0.8);
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        border-radius: 5px;
      }

      .legend h3 {
        font-size: 1.1em;
        font-weight: normal;
        color: #001323;
        margin: 0 0 10px 0;
      }

      .legend span {
        width: 20px;
        height: 20px;
        float: left;
        margin: 0 10px 4px 0;
      }

      .legend label {
        font-size: 1.1em;
      }

      .legend label:after {
        content: '';
        display: block;
        clear: both;
      }
    </style>
  </head>

  <body>
    <header>
      <h1>Rocky Mountain High - Population Growth in the Mountain States (2000-2017)</h1>

    </header>
    <section>

      <div class="row">
        <div id="map"></div>

        <div class="first-column">
          <h2> Map authored by Tim Kohaya for NewMaps Plus Course 672.</h2>

          <h4>About this Map</h4>
          <p>A lot of people are moving to the great American interior, better known as the Mountain States. Topographically
            dominated by the Rocky Mountains and smaller mountain ranges, the Mountain States are attracting many people from
            other parts of the country (particularly California) to relocate to the last of the Old West. You can see this trend
            by interacting with the above map which shows the percentage of population growth for counties and cities in the Mountain
            States between 2000 and 2017. You can hover over a county and see the countyâ€™s population and the percent change.
            You can also click on a city (had at least 30,000 population in 2000) and see the same information. Cities in blue have had
            a percentage gain in population while cities in red (only two) have had a percentage loss in population. The cities layer toggles off and on.</p>

          <h4>Data Sources</h4>
          <p>County population data layer produced by joining data downloaded from
            <a href="http://factfinder.census.gov/">American Fact Finder</a>
            with U.S. County polygons downloaded from <a href="https://www.census.gov/geo/maps-data/data/cbf/cbf_state.html">U.S. Boundary Shapefiles</a>.<br>

            <p>City population data layer produced by joining data downloaded from
              <a href="https://mapcruzin.com/free-wireless-gis-maps/free-wireless-gis-maps.htm">MapCruzin</a>
              with U.S. County polygons downloaded from <a href="https://www.census.gov/geo/maps-data/data/cbf/cbf_state.html">U.S. Boundary Shapefiles</a>.<br>

              <p>State boundaries downloaded from <a href="https://www.census.gov/geo/maps-data/data/cbf/cbf_state.html">U.S. Boundary Shapefiles</a>. All data
                prepared by U.S. Census Bureau, 2017.</p>
        </div>
        <div class="column">
          <img class="max-image-width" src="data/town.jpg" title="Telluride, Colorado">
          <div class="linkbox">
            Towns with western rustic charm and great scenery such as Telluride, Colorado, are attracting people to the Mountain States.
            Source: <a href="https://www.thrillist.com/travel/nation/the-best-mountain-towns-in-america">thrillist.com</a>
          </div>

        </div>
      </div>
    </section>
    <footer>
      <hr>
      <a href="https://newmapsplus.github.io">
        <img src="https://newmapsplus.github.io/assets/graphics/logo-2018-nmp-75px-h-gray.png" alt="University of Kentucky Geography">
      </a>
  
      <a href="https://uky-gis.github.io">
        <img src="https://newmapsplus.github.io/assets/graphics/logo-2018-geography-75px-h.png" alt="University of Kentucky Geography">
      </a>
    </footer>


    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js"></script>
    <script src="https://unpkg.com/simple-statistics@6.1.1/dist/simple-statistics.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"></script>
    <script src="data/mountain_cities5.js"></script>
    <script>
      // Map options
      var options = {
        center: [40.76, -109.89],
        zoom: 5.0,
        zoomSnap: .1
      }
      // Create a Leaflet map in our division container with id of 'map'
      var map = L.map('map', options);
      // Leaflet providers base map URL
      var basemap_source =
        'https://cartodb-basemaps-{s}.global.ssl.fastly.net/rastertiles/dark_all/{z}/{x}/{y}.png'
      // Leaflet providers attributes
      var basemap_options = {
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',
        subdomains: 'abcd',
        maxZoom: 19
      };
      // Request some basemap tiles and add to the map
      var tiles = L.tileLayer(basemap_source, basemap_options).addTo(map);
      var attributeValue = "percent_change"; // variable for eachLayer function below
      // load counties_pops layer----------------------------------------------
      var dataLayer
      var countyLayer = $.getJSON("data/counties_pops.geojson", function(data) {
        dataLayer = L.geoJson(data, {
          style: function(feature) {
            return {
              color: '#dddddd',
              weight: 1.3,
              fillOpacity: 0.9,
              fillColor: '#1f78b4'
            };
          }
        }).addTo(map);
        drawMap(dataLayer);
      });
      // end load counties_pops layer---------------------------------------------
      // begin drawMap function---------------------------------------------------
      function drawMap(dataLayer) {
        var breaks = getClassBreaks(dataLayer);
        drawLegend(breaks) // call to drawLegend function below
        // loop through all the counties
        dataLayer.eachLayer(function(layer) {
          var props = layer.feature.properties;
          layer.setStyle({
            fillColor: getColor(props[attributeValue], breaks)
          }); // call to getColor function
          // bind tooltip with script
          layer.bindTooltip("<b>" + "County:" + " " + "</b>" + layer.feature.properties.NAME + "</br>" +
            "<b>" + "2000 Pop:" + " " + "</b>" + layer.feature.properties.pop_2000.toLocaleString() +
            "</br>" + "<b>" + "2017 Pop:" + " " + "</b>" + layer.feature.properties.pop_2017.toLocaleString() +
            "<b>" + "</br>" + "Percent Change:" + "</b>" + " " + layer.feature.properties.percent_change + "%");
        });
      }
      // begin getClassBreaks function--------------------------------------------
      function getClassBreaks(dataLayer) {
        // create empty Array for storing values
        var values = [];
        // loop through all the counties
        dataLayer.eachLayer(function(layer) {
          var props = layer.feature.properties;
          var value = props[attributeValue];
          values.push(value);
        });
        // determine similar clusters
        var clusters = ss.ckmeans(values, 5);
        // create an array of the lowest value within each cluster
        var breaks = clusters.map(function(cluster) {
          return [cluster[0], cluster.pop()];
        });

        return breaks; // return Array of class breaks
      } // end getClassBreaks function--------------------------------------------
      // begin getColor function--------------------------------------------------
      function getColor(d, breaks) {

        return d <= breaks[0][1] ? '#BDBDBD' :
          d <= breaks[1][1] ? '#fdbe85' :
          d <= breaks[2][1] ? '#fd8d3c' :
          d <= breaks[3][1] ? '#e6550d' :
          d <= breaks[4][1] ? '#a63603' :
          'whitesmoke'; // Should have none of these
      }
      // end getColor function----------------------------------------------------
      // begin drawLegend function------------------------------------------------
      function drawLegend(breaks) {
        // create a new Leaflet control object, and position it bottom left
        var legend = L.control({
          position: 'bottomleft'
        });
        // when the legend is added to the map
        legend.onAdd = function() {
          // create a new HTML <div> element and give it a class name of "legend"
          var div = L.DomUtil.create('div', 'legend');
          // first append an <h3> tag to the div holding the current attribute
          // and norm values (i.e., the mapped phenomena)
          div.innerHTML = "<h3>" + "Percent Gain/Loss" + "</h3>";
          // for each of our breaks
          for (var i = 0; i < breaks.length; i++) {
            // determine the color associated with each break value,
            // including the lower range value
            var color = getColor(breaks[i][1], breaks);
            // concatenate a <span> tag styled with the color and the range values
            // of that class and include a label with the low and a high ends of that class range
            div.innerHTML +=
              '<span style="background:' + color + '"></span> ' +
              '<label>' + (breaks[i][0]).toLocaleString() + '% &mdash; ' +
              (breaks[i][1]).toLocaleString() + '%</label>';
          }
          // return the populated div to be added to the map
          return div;
        };
        // add the legend to the map
        legend.addTo(map);
      }
      // end drawLegend function--------------------------------------------------
      // add mountain states layer------------------------------------------------
      // Tell jQuery to wait until data is loaded before executing a function
      $.when(countyLayer).done(function() {
        // load and style the state outline
        $.getJSON("data/mountain_states.geojson", function(data) {
          var stateLayer = L.geoJson(data, {
            style: function(feature) {
              return {
                color: 'black',
                weight: .6,
                fillOpacity: 0,
                // This property allows us control interactivty of layer
                interactive: false
              };
            },
          });
          // Add layer to map!
          stateLayer.addTo(map)
        });
      });
      // end add mountain states layer--------------------------------------------
      // begin add mountain cities layer------------------------------------------
      // Tell jQuery to wait until data is loaded before executing a function
      $.when(countyLayer).done(function() {
        cities.features.sort(function(a, b) {
          // prevent overlapping of city proportional circles
          return b.properties.percent_change - a.properties.percent_change;
        });
        // begin loading mountain cities layer------------------------------------
        var mountainCities = L.geoJson(cities, {

          pointToLayer: function(feature, latlng) {
            return L.circleMarker(latlng, {});
          },
          // end loading mountain cities Layer------------------------------------
          // Start onEachFeature function-----------------------------------------
          onEachFeature: function(feature, layer) {

            // apply mouseover function
            layer.on('mouseover', function() {
              layer.setStyle({
                fillColor: 'yellow',
                fillOpacity: .6
              });
            });

            // end mouseover function

            //Prepare tooltip string with for/in loop
            for (var key in layer.feature.properties.percent_change) {
              layer.bindPopup("<b>" + "City:" + " " + "</b>" + feature.properties.NAME + "," + " " +
                feature.properties.STATE + "</br>" + "<b>" + "2000 Pop:" + " " + "</b>" +
                feature.properties.pop_2000.toLocaleString() + "</br>" + "<b>" + "2017 Pop:" +
                " " + "</b>" + feature.properties.pop_2017.toLocaleString() + "<b>" + "</br>" +
                "Percent Change:" + "</b>" + " " + feature.properties.percent_change + "%");
            }

            // Create mouseover style
            layer.on('mouseover', function() {
              layer.setStyle({
                fillColor: 'yellow'
              })
            })

            // bind popup to each feature
            layer.bindPopup("<b>" + "City:" + " " + "</b>" + feature.properties.NAME + "," + " " +
              feature.properties.STATE + "</br>" + "<b>" + "2000 Pop:" + " " + "</b>" +
              feature.properties.pop_2000.toLocaleString() + "</br>" + "<b>" + "2017 Pop:" +
              " " + "</b>" + feature.properties.pop_2017.toLocaleString() + "<b>" + "</br>" +
              "Percent Change:" + "</b>" + " " + feature.properties.percent_change + "%");

            // Apply layer styles and mouseover styles to cities with population gain and cities with
            // population loss using if/else if statement----------------------------------------------------------
            if (feature.properties.percent_change > 0) {
              // Apply layer styles
              layer.setStyle({
                weight: 1,
                color: '#314DFE',
                fillColor: '#314DFE',
                fillOpacity: .4,
                radius: getRadius(feature.properties.percent_change) // calls getRadius function
              });
              // Apply mouseout styles
              layer.on('mouseout', function() {
                layer.setStyle({
                  fillColor: '#314DFE',
                  fillOpacity: .4,
                  color: '#314DFE'
                });
              });
            } else if (feature.properties.percent_change < 0) {
              // Apply layer styles
              layer.setStyle({
                weight: 1,
                color: 'red',
                fillColor: 'red',
                fillOpacity: .4,
                radius: getRadius(feature.properties.percent_change) // calls getRadius function
              });
              // Apply mouseout styles
              layer.on('mouseout', function() {
                layer.setStyle({
                  fillColor: 'red',
                  fillOpacity: .4,
                  color: 'red'
                });
              });
            }
          }
        })
        // end add mountain cities layer------------------------------------------
        // begin getRadius function-----------------------------------------------
        function getRadius(area) {
          var radius = Math.sqrt(area / Math.PI);
          return radius * 3;
        }
        // end getRadiusfunction--------------------------------------------------

        // begin L control layers method------------------------------------------
        var sourcesLayers = {

          "Cities": mountainCities
        }
        L.control.layers(null, sourcesLayers, {
          collapsed: false
        }).addTo(map);
        // end L control layers method--------------------------------------------

      }) // end when.done function------------------------------------------------
    </script>

  </body>

  </html>
